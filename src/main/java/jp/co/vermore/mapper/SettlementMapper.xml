<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="jp.co.vermore.mapper.SettlementMapper" >
  <resultMap id="BaseResultMap" type="jp.co.vermore.entity.Settlement" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 13 13:05:39 CST 2018.
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="customer_id" property="customerId" jdbcType="INTEGER" />
    <result column="item_type" property="itemType" jdbcType="TINYINT" />
    <result column="item_id" property="itemId" jdbcType="INTEGER" />
    <result column="type" property="type" jdbcType="TINYINT" />
    <result column="amount" property="amount" jdbcType="INTEGER" />
    <result column="yyyymm" property="yyyymm" jdbcType="INTEGER" />
    <result column="status" property="status" jdbcType="BIT" />
    <result column="method" property="method" jdbcType="TINYINT" />
    <result column="title" property="title" jdbcType="VARCHAR" />
    <result column="content" property="content" jdbcType="VARCHAR" />
    <result column="create_datetime" property="createDatetime" jdbcType="TIMESTAMP" />
    <result column="update_datetime" property="updateDatetime" jdbcType="TIMESTAMP" />
    <result column="del_flg" property="delFlg" jdbcType="BIT" />
    <result column="note" property="note" jdbcType="VARCHAR" />
  </resultMap>

  <resultMap id="settlementForm" type="jp.co.vermore.form.admin.SettlementListForm">
    <result column="customer_id" property="customerId"  />
    <result column="login_name" property="customerName" />
    <result column="uuid" property="shopUUID" />
    <result column="yyyymm" property="month" />
    <result column="amountTotal" property="amountTotal" />
    <result column="status" property="status" />
    <result column="sname" property="shopName" />
  </resultMap>

  <resultMap id="settlementEditForm" type="jp.co.vermore.form.admin.SettlementEditForm">
      <result column="login_name" property="customerName" />
      <result column="uuid" property="shopUUID" />
      <result column="type" property="type" />
      <result column="amount" property="amount" />
      <result column="status" property="status" />
      <result column="name" property="shopName" />
      <result column="method" property="method" />
      <result column="title" property="title" />
      <result column="content" property="content" />
      <result column="create_datetime" property="createDatetime" />
      <result column="update_datetime" property="updateDatetime" />
  </resultMap>

  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 13 13:05:39 CST 2018.
    -->
    id, customer_id, item_type, item_id, type, amount, yyyymm, status, method, title, 
    content, create_datetime, update_datetime, del_flg, note
  </sql>

  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 13 13:05:39 CST 2018.
    -->
    select 
    <include refid="Base_Column_List" />
    from settlement
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 13 13:05:39 CST 2018.
    -->
    delete from settlement
    where id = #{id,jdbcType=INTEGER}
  </delete>

  <insert id="insert" parameterType="jp.co.vermore.entity.Settlement" >
    insert into settlement (id, customer_id, item_type, 
      item_id, type, amount, 
      yyyymm, status, method, 
      title, content, create_datetime, 
      update_datetime, del_flg, note
      )
    values (#{id,jdbcType=INTEGER}, #{customerId,jdbcType=INTEGER}, #{itemType,jdbcType=TINYINT}, 
      #{itemId,jdbcType=INTEGER}, #{type,jdbcType=TINYINT}, #{amount,jdbcType=INTEGER}, 
      #{yyyymm,jdbcType=INTEGER}, #{status,jdbcType=BIT}, #{method,jdbcType=TINYINT}, 
      #{title,jdbcType=VARCHAR}, #{content,jdbcType=VARCHAR}, #{createDatetime,jdbcType=TIMESTAMP}, 
      #{updateDatetime,jdbcType=TIMESTAMP}, #{delFlg,jdbcType=BIT}, #{note,jdbcType=VARCHAR}
      )
    <selectKey resultType="Long" keyProperty="id" order="AFTER">
      select @@IDENTITY
    </selectKey>
  </insert>

  <insert id="insertSelective" parameterType="jp.co.vermore.entity.Settlement" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 13 13:05:39 CST 2018.
    -->
    insert into settlement
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="customerId != null" >
        customer_id,
      </if>
      <if test="itemType != null" >
        item_type,
      </if>
      <if test="itemId != null" >
        item_id,
      </if>
      <if test="type != null" >
        type,
      </if>
      <if test="amount != null" >
        amount,
      </if>
      <if test="yyyymm != null" >
        yyyymm,
      </if>
      <if test="status != null" >
        status,
      </if>
      <if test="method != null" >
        method,
      </if>
      <if test="title != null" >
        title,
      </if>
      <if test="content != null" >
        content,
      </if>
      <if test="createDatetime != null" >
        create_datetime,
      </if>
      <if test="updateDatetime != null" >
        update_datetime,
      </if>
      <if test="delFlg != null" >
        del_flg,
      </if>
      <if test="note != null" >
        note,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="customerId != null" >
        #{customerId,jdbcType=INTEGER},
      </if>
      <if test="itemType != null" >
        #{itemType,jdbcType=TINYINT},
      </if>
      <if test="itemId != null" >
        #{itemId,jdbcType=INTEGER},
      </if>
      <if test="type != null" >
        #{type,jdbcType=TINYINT},
      </if>
      <if test="amount != null" >
        #{amount,jdbcType=INTEGER},
      </if>
      <if test="yyyymm != null" >
        #{yyyymm,jdbcType=INTEGER},
      </if>
      <if test="status != null" >
        #{status,jdbcType=BIT},
      </if>
      <if test="method != null" >
        #{method,jdbcType=TINYINT},
      </if>
      <if test="title != null" >
        #{title,jdbcType=VARCHAR},
      </if>
      <if test="content != null" >
        #{content,jdbcType=VARCHAR},
      </if>
      <if test="createDatetime != null" >
        #{createDatetime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateDatetime != null" >
        #{updateDatetime,jdbcType=TIMESTAMP},
      </if>
      <if test="delFlg != null" >
        #{delFlg,jdbcType=BIT},
      </if>
      <if test="note != null" >
        #{note,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>

  <update id="updateByPrimaryKeySelective" parameterType="jp.co.vermore.entity.Settlement" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 13 13:05:39 CST 2018.
    -->
    update settlement
    <set >
      <if test="customerId != null" >
        customer_id = #{customerId,jdbcType=INTEGER},
      </if>
      <if test="itemType != null" >
        item_type = #{itemType,jdbcType=TINYINT},
      </if>
      <if test="itemId != null" >
        item_id = #{itemId,jdbcType=INTEGER},
      </if>
      <if test="type != null" >
        type = #{type,jdbcType=TINYINT},
      </if>
      <if test="amount != null" >
        amount = #{amount,jdbcType=INTEGER},
      </if>
      <if test="yyyymm != null" >
        yyyymm = #{yyyymm,jdbcType=INTEGER},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=BIT},
      </if>
      <if test="method != null" >
        method = #{method,jdbcType=TINYINT},
      </if>
      <if test="title != null" >
        title = #{title,jdbcType=VARCHAR},
      </if>
      <if test="content != null" >
        content = #{content,jdbcType=VARCHAR},
      </if>
      <if test="createDatetime != null" >
        create_datetime = #{createDatetime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateDatetime != null" >
        update_datetime = #{updateDatetime,jdbcType=TIMESTAMP},
      </if>
      <if test="delFlg != null" >
        del_flg = #{delFlg,jdbcType=BIT},
      </if>
      <if test="note != null" >
        note = #{note,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="jp.co.vermore.entity.Settlement" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jun 13 13:05:39 CST 2018.
    -->
    update settlement
    set customer_id = #{customerId,jdbcType=INTEGER},
      item_type = #{itemType,jdbcType=TINYINT},
      item_id = #{itemId,jdbcType=INTEGER},
      type = #{type,jdbcType=TINYINT},
      amount = #{amount,jdbcType=INTEGER},
      yyyymm = #{yyyymm,jdbcType=INTEGER},
      status = #{status,jdbcType=BIT},
      method = #{method,jdbcType=TINYINT},
      title = #{title,jdbcType=VARCHAR},
      content = #{content,jdbcType=VARCHAR},
      create_datetime = #{createDatetime,jdbcType=TIMESTAMP},
      update_datetime = #{updateDatetime,jdbcType=TIMESTAMP},
      del_flg = #{delFlg,jdbcType=BIT},
      note = #{note,jdbcType=VARCHAR}
    where id = #{id,jdbcType=INTEGER}
  </update>

  <select id="getSettlementAllByMonth" resultMap="settlementForm">
      SELECT ac.login_name, MIN(s.name) AS sname, MIN(s.uuid) AS uuid, MIN(se.yyyymm) AS yyyymm, SUM(se.amount) AS amountTotal, MIN(se.status) AS status
      FROM settlement AS se
      LEFT JOIN admin_customer AS  ac  ON se.customer_id = ac.id
      LEFT JOIN shop AS s ON se.item_id = s.id
      WHERE se.del_flg = 0 AND  s.del_flg = 0 AND  ac.del_flg = 0
      <if test="month != null ">
        AND se.yyyymm=#{month}
      </if>
      <if test="shopUUID != null and shopUUID != ''">
        AND s.uuid = #{shopUUID}
      </if>
      <if test="customerName != null and customerName != ''">
        AND ac.login_name = #{customerName}
      </if>
      <if test="selStatus == 1">
        AND se.status = 0
      </if>
      <if test="selStatus == 2">
        AND se.status = 1
      </if>
      <if test="shopName != null and shopName != '' ">
        AND s.name LIKE '%${shopName}%'
      </if>
      GROUP BY se.customer_id,se.yyyymm
      ORDER BY ${orderStatement}
      LIMIT #{length} OFFSET #{start}
  </select>

  <select id="getSettlementCountByMonth" resultType="int">
    SELECT COUNT(1)
    FROM (
      SELECT se.customer_id
      FROM settlement AS se
      LEFT JOIN admin_customer AS  ac  ON se.customer_id = ac.id
      LEFT JOIN shop AS s ON se.item_id = s.id
      WHERE se.del_flg = 0 AND s.del_flg = 0 AND  ac.del_flg = 0
      <if test="month != null and month != '0'">
        AND se.yyyymm=#{month}
      </if>
      <if test="shopUUID != null and shopUUID != ''">
        AND s.uuid = #{shopUUID}
      </if>
      <if test="customerName != null and customerName != ''">
        AND ac.login_name = #{customerName}
      </if>
      <if test="selStatus == 1">
        AND se.status = 0
      </if>
      <if test="selStatus == 2">
        AND se.status = 1
      </if>
      <if test="shopName != null and shopName != '' ">
        AND s.name LIKE '%${shopName}%'
      </if>
      GROUP BY se.customer_id,se.yyyymm) t
  </select>

    <select id="getSettlementCount" resultType="int">
        SELECT COUNT(1)
        FROM (
        SELECT se.customer_id
        FROM settlement AS se
        LEFT JOIN admin_customer AS  ac  ON se.customer_id = ac.id
        LEFT JOIN shop AS s ON se.item_id = s.id
        WHERE se.del_flg = 0 AND s.del_flg = 0 AND  ac.del_flg = 0
        GROUP BY se.customer_id,se.yyyymm) t
    </select>


    <select id="getSettlementEditByMonth" resultMap="settlementEditForm">
        SELECT
        se.type , se.amount , se.status , se.method , se.title ,
        se.content , s.uuid ,s.name , ac.login_name, se.create_datetime , se.update_datetime
        FROM settlement AS se
        LEFT JOIN shop AS s ON s.id=#{shopID}
        LEFT JOIN admin_customer AS ac ON ac.shop_id = #{shopID}
        WHERE se.del_flg = 0 AND se.item_id = #{shopID}
      <if test="month != null and month != ''">
        AND se.update_datetime=#{month}
      </if>
    </select>

  <select id="getSettlementEditByMonth2" resultMap="settlementEditForm">
    SELECT
    se.type , se.amount , se.status , se.method , se.title ,
    se.content , s.uuid ,s.name , ac.login_name, se.create_datetime
    FROM settlement AS se
    LEFT JOIN shop AS s ON s.id=#{param1}
    LEFT JOIN admin_customer AS ac ON ac.shop_id = #{param1}
    WHERE se.del_flg = 0 AND se.item_id = #{param1} AND se.yyyymm=#{param2}
  </select>

  <select id="getSettlementAllByMonthForNotify" resultMap="settlementForm">
    SELECT se.customer_id , ac.login_name, MIN(s.name) AS sname, MIN(s.uuid) AS uuid, MIN(se.yyyymm) AS yyyymm, SUM(se.amount) AS amountTotal, MIN(se.status) AS status
    FROM settlement AS se
    LEFT JOIN admin_customer AS  ac  ON se.customer_id = ac.id
    LEFT JOIN shop AS s ON se.item_id = s.id
    WHERE se.del_flg = 0 AND  s.del_flg = 0 AND  ac.del_flg = 0
    <if test="_parameter != 0 ">
      AND se.yyyymm=#{_parameter}
    </if>
    GROUP BY se.customer_id,se.yyyymm
  </select>

</mapper>